#!/usr/bin/env ruby
$-w = true
require File.dirname(__FILE__)+"/../lib/all"

if ARGV.size != 3
  $stderr.puts "Usage: ProcessSources <PkgList> <Distro1> <Distro2>"
  exit 1
end

dist1 = ARGV[1]
dist2 = ARGV[2]


sinfo1 = SourcesInfo.new(dist1)
sinfo2 = SourcesInfo.new(dist2)
re = RuleEngine.new(sinfo1, sinfo2)

bins = File.new(ARGV[0]).map {|line| pkg, number = line.split; pkg}
re.process(bins)

$stderr.puts "Finished determining package matchups, #{re.errors} errors and #{re.warnings} warnings"
if re.errors > 0
  $stderr.puts "Aborting due to errors in package matchups, correct those to advance"
  exit 1
end

$stderr.puts "Success!! Proceeding with comparison"
matchups = re.matchups
matchups.each_with_index do |s1,s2, i| 
  $stderr.puts "Comparison #{i}/#{matchups.size}: #{s1 ? s1 : "nil"} with #{s2 ? s2 : "nil"}"
  Comparator.compare(s1, s2, sinfo1, sinfo2)
end
